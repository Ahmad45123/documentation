---
title: Ingestion Mechanisms
kind: documentation
aliases:
    - /tracing/ingestion/ingestion_mechanisms
description: "What are the mechanisms in the tracer and the agent controlling the trace ingestion"
---

Multiple mechanisms are responsible for choosing if spans generated by your applications are sent to Datadog. The logic behind these mechanisms lie in the tracing libraries and/or in the trace agent. Depending on the configuration, all or parts the traffic generated by instrumented services are ingested.

To each span ingested is attached a unique **ingestion reason**, referring to one of the mechanisms described here. Usage metrics `datadog.estimated_usage.apm.ingested_bytes` and `datadog.estimated_usage.apm.ingested_spans` are tagged by `ingestion_reason`.

## Head-based default mechanism
_ingestion\_reason : auto_

By default, traces are sampled following a head-based sampling mechanism. The sampling decision is taken at the start of a root span, for a specific `service` and `env`. A part of the requests generated by one service will be sampled and sent to the backend. The decision is propagated through a priority tag in the http headers to downstream services to make sure to capture complete traces.

### In the agent

The trace-agent continuously sends sampling rates to tracing libraries to apply at the root of traces. The trace-agent allocates `10 chunks-per-second` distributed to services depending on the traffic.

For instance, if service `A` has a higher traffic than service `B`, the trace-agent could allocate `7` chunks-per-second for service `A` and `3` chunks-per-second for service `B`

The rate can be set in the agent main configuration file (datadog.yaml) or as an environment variable :
```
@param max_traces_per_second - integer - optional - default: 10
@env DD_APM_CONFIG_MAX_TRACES_PER_SECOND - integer - optional - default: 10
```

### In Tracing librairies : User-defined Rules

At the library level, some additional rules can be enforced.
- Set a specific sampling rate applied to all root services to override agent feedback loop [Default Mechanism](#default-mechanism)
- Set a maximum number of ingested traces-per-second (`maxTPS` rate limit) to limit the ingestion volume
- Set a specific sampling rate applied to a specified root service

**Note :** Theses rules also follow a head-based sampling mechanism. If the traffic on a service is higher than the defined `maxTPS`, traces are dropped from the root. It does not create incomplete traces.

The configuration can be set directly in the code, or as environment variables :

{{< tabs >}}
{{% tab "Code API" %}}

```
# in dd-trace-py
# Sample 10% of all traces with rate limit of 100 traces per second sampled
# and an override sample rate for a specific service
tracer.configure(sampler=DatadogSampler(
    default_sample_rate=0.10,
    rate_limit=100,
    rules=[
      # 100% sampled for “my-service”, but 100 traces per second rate limit still honored
      SamplingRule(sample_rate=1.0, service=’my-service’),
    ],
)
```

{{% /tab %}}
{{% tab "Environment variables" %}}

```
@env  DD_TRACE_RATE_LIMIT - integer - optional 100 (if using the agent feedback loop the rate limiter is ignored)
@env  DD_TRACE_SAMPLE_RATE - integer - optional null (defaults to agent feedback loop)
@env DD_TRACE_SAMPLING_RULES - integer - optional null
```

{{% /tab %}}
{{< /tabs >}}

**Note :** Services configured with user-defined rules are marked as `Configured` in the [Ingestion Control Page][1] Configuration column. Services sampling according to the default agent distributed rate are labelled with an `Automatic` configuration.

## Force Keep and Drop
_ingestion\_reason : manual_

Head-based sampling mechanism can be overriden at the tracing library level. For instance, if you need to monitor a critical transaction, force the associated trace to be kept. On the other hand, for unnecessary or repetitive information like health checks, force the trace to be dropped.

- Set ManualKeep at the span level to make sure that all child spans and next distributed calls will be sent to the backend. The trace can still be partially complete if the span in question is not the root span of the trace.
```
# in dd-trace-go
span.SetTag(ext.ManualKeep, true)
```
- Set ManualDrop to make sure that **no** child span or next distributed calls will be sent to the backend. Downstream, [Error and rare samplers](#error-and-rare-traces) will be ignored at the agent level.
```
span.SetTag(ext.ManualDrop, true)
```

## Single spans (analytics enabled)

### In the tracing librairies

### In the agent

## Error and rare traces

### Error traces

### Rare traces

[1]: /tracing/trace_ingestion/control_page

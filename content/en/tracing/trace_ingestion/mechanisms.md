---
title: Ingestion Mechanisms
kind: documentation
aliases:
    - /tracing/ingestion/ingestion_mechanisms
description: "What are the mechanisms in the tracer and the agent controlling the trace ingestion"
---

Multiple mechanisms are responsible for choosing if spans generated by your applications are sent to Datadog. The logic behind these mechanisms lie in the tracing libraries and/or in the trace agent. Depending on the configuration, all or parts the traffic generated by instrumented services are ingested.

To each span ingested is attached a unique **ingestion reason**, referring to one of the mechanisms described here. Usage metrics `datadog.estimated_usage.apm.ingested_bytes` and `datadog.estimated_usage.apm.ingested_spans` are tagged by `ingestion_reason`.

## Head-based default mechanism
_ingestion\_reason : auto_

By default, traces are sampled following a head-based sampling mechanism. The sampling decision is taken at the start of a root span, for a specific `service` and `env`. A part of the requests generated by one service will be sampled and sent to the backend. The decision is propagated through a priority tag in the http headers to downstream services to make sure to capture complete traces.

### In the agent

The trace-agent continuously sends sampling rates to tracing libraries to apply at the root of traces. The trace-agent allocates `10 chunks-per-second` distributed to services depending on the traffic.

For instance, if service `A` has a higher traffic than service `B`, the trace-agent could allocate `7` chunks-per-second for service `A` and `3` chunks-per-second for service `B`

The rate can be set in the agent main configuration file (datadog.yaml) or as an environment variable :
```
@param max_traces_per_second - integer - optional - default: 10
@env DD_APM_CONFIG_MAX_TRACES_PER_SECOND - integer - optional - default: 10
```

### In Tracing librairies : User-defined Rules
_ingestion\_reason : rule_

At the library level, some additional rules can be enforced.
- Set a specific sampling rate applied to all root services to override agent feedback loop [Default Mechanism](#default-mechanism)
- Set a maximum number of ingested traces-per-second (`maxTPS` rate limit) to limit the ingestion volume
- Set a specific sampling rate applied to a specified root service

**Note :** Theses rules also follow a head-based sampling mechanism. If the traffic on a service is higher than the defined `maxTPS`, traces are dropped from the root. It does not create incomplete traces.

The configuration can be set directly in the code, or as environment variables :

{{< tabs >}}
{{% tab "Code API" %}}

```
# in dd-trace-py
# Sample 10% of all traces with rate limit of 100 traces per second sampled
# and an override sample rate for a specific service
tracer.configure(sampler=DatadogSampler(
    default_sample_rate=0.10,
    rate_limit=100,
    rules=[
      # 100% sampled for “my-service”, but 100 traces per second rate limit still honored
      SamplingRule(sample_rate=1.0, service=’my-service’),
    ],
)
```

{{% /tab %}}
{{% tab "Environment variables" %}}

```
@env  DD_TRACE_RATE_LIMIT - integer - optional 100 (if using the agent feedback loop the rate limiter is ignored)
@env  DD_TRACE_SAMPLE_RATE - integer - optional null (defaults to agent feedback loop)
@env DD_TRACE_SAMPLING_RULES - integer - optional null
```

{{% /tab %}}
{{< /tabs >}}

**Note :** Services configured with user-defined rules are marked as `Configured` in the [Ingestion Control Page][1] Configuration column. Services sampling according to the default agent distributed rate are labelled with an `Automatic` configuration.

## Force Keep and Drop
_ingestion\_reason : manual_

Head-based sampling mechanism can be overriden at the tracing library level. For instance, if you need to monitor a critical transaction, force the associated trace to be kept. On the other hand, for unnecessary or repetitive information like health checks, force the trace to be dropped.

- Set ManualKeep at the span level to make sure that all child spans and next distributed calls will be sent to the backend. The trace can still be partially complete if the span in question is not the root span of the trace.
```
// in dd-trace-go
span.SetTag(ext.ManualKeep, true)
```
- Set ManualDrop to make sure that **no** child span or next distributed calls will be sent to the backend. Downstream, [Error and rare samplers](#error-and-rare-traces) will be ignored at the agent level.
```
span.SetTag(ext.ManualDrop, true)
```

## Single spans (analytics enabled)
_ingestion\_reason : analytic_


If you need to sample a specific span, but you don't necessarily need the full trace to be available, tracers allow setting a sampling rate on a single span. This span will be sent alone to the backend if the trace is not sampled.

### In the tracing librairies

To use the analytics mechanism, it must be enabled, either in the code, or via an environment variable. Furthermore, define a sampling rate to be applied to all `analytics_enabled` span:

{{< tabs >}}
{{% tab "Code API" %}}

```
// in dd-trace-go
// set analytics_enabled by default
tracerconfig.WithAnalytics(on bool)
// set raw sampling rate to apply on all analytics_enabled spans
tracerconfig.SetAnalyticsRate(0.4)
```

{{% /tab %}}
{{% tab "Environment variables" %}}

```
@env  DD_TRACE_ANALYTICS_ENABLED - boolean - optional false
```
{{% /tab %}}
{{< /tabs >}}

Tag any single span with `analytics_enabled:true`. In addition, specify a sampling rate to be associated with the span:
```
// make a span analytics_enabled
span.SetTag(ext.AnalyticsEvent, true)
// make a spans analytics_enabled with a rate of 0.5
s := tracer.StartSpan("redis.cmd", AnalyticsRate(0.5))
```

### In the agent

In the trace-agent, an additional rate limiter is set to 200 spans per second. If the limit is reached, some spans are be dropped and not forwarded to Datadog.

The rate can be set in the agent main configuration file (datadog.yaml) or as an environment variable :
```
@param max_events_per_second - integer - optional 200
@env DD_APM_CONFIG_MAX_EVENTS_PER_SECOND - integer - optional 200
```

## Error and rare traces

For traces not caught by the head-based sampling, agent mechanisms make sure that critical and diverse traces are kept and ingested. These 2 samplers use a stratified sampling reservoir algorithm to keep a diverse set of traces (by catching all combinations of a pre-determined set of tags):

- **Error traces :** sampling errors is important to provide visibility on potential system failures
- **Rare traces :** sampling rare traces allows you to keep visibility on your system as a whole, by making sure that low-traffic services and resource are still monitored.


### Error traces
_ingestion\_reason : error_

The error sampler catches pieces of traces containing error spans that are not caught by head based sampling. It distributes a `10 traces-per-second` rate to catch all combinations of `service`, `name`, `resource`, `http.status` and `error.type`.

From agent version 7.33, the error sampler can be configured in the agent main configuration file (datadog.yaml) or with environment variables :
```
@param errors_per_second - integer - optional - default: 10
@env DD_APM_ERROR_TPS - integer - optional - default: 10
```

**Note:** Set the parameter to `0` to disable the error sampler

### Rare traces
_ingestion\_reason : rare_

The rare sampler is sending a set of rare spans to Datadog.
Rare sampler are also distributes a rate to catch combinations of `env`, `service`, `name`, `resource`, `error.type` and `http.status`. The default sampling rate for rare traces is `5 chunks-per-seconds`.

From agent version 7.33, the rare sampler can be disabled in the agent main configuration file (datadog.yaml) or with an environment variable :

```
@params apm_config.disable_rare_sample - boolean - optional - default: false
@env DD_APM_DISABLE_RARE_SAMPLER - boolean - optional - default: false
```

**Note:** Sampled traces will likely be incomplete, as this mechanism occurs downstream of the head-based sampling. There is no way to guarantee that the agent will receive a complete trace from the tracing libraries.

## Product ingested spans

Some additional ingestion reasons are attributed to spans generated by a specific Datadog product.

| Product    | ingestion_reason                    |
|------------|-------------------------------------|
| Synthetics | `synthetics` & `synthetics-browser` |
| RUM        | `RUM`                               |
| Serverless | `lambda` & `xray`                   |
| CI App     | `ci_app`                            |
| Appsec     | `appsec`                            |

[1]: /tracing/trace_ingestion/control_page
